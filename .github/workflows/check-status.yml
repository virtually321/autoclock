name: ✅ Check Duty/休班状态并提交 status.txt

on:
  schedule:
    - cron: '0 12 * * *'  # 每日 UTC 12 点 （北京时间 20:00）
  push:
    branches:
      - main
    paths:
      - zb.txt
      - xj.txt

jobs:
  run_check:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 克隆代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: 📈 生成 status.txt
        run: python check_status.py

      - name: 🧐【DEBUG】查看 status.txt 当前内容
        run: |
          cat -e status.txt  # 包含 $ 代表末尾有换行符
          cat status.txt     # 实际值 0 或 1

      - name: 🧾 检查文件是否更新
        id: check_diff_status
        run: |
          # 与当前分支对比，检查 diff
          updated_status=$(git diff --no-prefix origin/main status.txt | head -n 1 | grep '^[+-]' | head -c 1)

          if [ "$updated_status" = "+" ]; then
            echo "::set-output name=changed::true"
          else
            echo "::set-output name=changed::false"
          fi

      - name: 📤 自动生成 Git Commit 提交 status.txt
        if: steps.check_diff_status.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: status.txt
          commit_message: "🔔 status 更新：$(cat status.txt)"
