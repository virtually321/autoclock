name: 精准状态生成
on:
  schedule:
    - cron: '0 21 * * *'  # 北京时间05:00
  push:
    paths:
      - 'duty'
      - 'leave'

jobs:
  status-generator:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
    - uses: actions/checkout@v4

    # ===== 精准核心逻辑 =====
    - name: 生成状态
      run: |
        TODAY=$(date +"%F")
        TEMP_FILE=$(mktemp)
        
        # 文件优先策略
        if grep -m1 -q "^$TODAY$" duty; then
          echo 1 > $TEMP_FILE
        elif grep -m1 -q "^$TODAY$" leave; then
          echo 0 > $TEMP_FILE
        else
          # 直接使用API返回值
          curl -fsS --max-time 5 "https://yasumi.neko7ina.com/" > $TEMP_FILE
          grep -qE '^[01]$' $TEMP_FILE || cp status $TEMP_FILE
        fi

        # 原子替换
        mv $TEMP_FILE status

    # ===== 安全提交 =====
    - uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "状态更新 [${{ env.TODAY }}]"
        file_pattern: 'status'
