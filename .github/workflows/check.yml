name: 极简打卡系统
on:
  schedule:
    - cron: '0 8,16 * * *'
      time_zone: Asia/Shanghai
  push:
    branches:
      - main
    paths:
      - 'duty'
      - 'leave'
      - 'src/**/*.duty'
      - 'docs/leave'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: 仅当日日期行改动时才执行
      id: check_date
      run: |
        set -o errexit -o nounset
        TODAY=$(date +%F)
        CHANGED_FILES="duty leave $(find src -name *.duty -o -name *.leave 2>/dev/null)"
        for file in $CHANGED_FILES; do
          # 检查文件是否真的“改了”
          if [ -f "$file" ]; then
            git diff --word-diff=porcelain HEAD^ HEAD "$file" | grep -E -q "([+−]-)?$TODAY"
            if [ $? -eq 0 ]; then
              echo '::set-output name=trigger::true'
              exit 0
            fi
          fi
        done
        echo '::set-output name=trigger::false'

    - name: 构建status并更新
      if: steps.check_date.outputs.trigger == 'true'
      run: |
        TODAY=$(date +%F)
        touch duty leave

        if grep -qxF "$TODAY" duty; then
          echo 1 > status
          echo "::notice:: duty中记录为休息日"
        elif grep -qxF "$TODAY" leave; then
          echo 0 > status
          echo "::notice:: leave中记录为工作日"
        else
          if api_result=$(curl -sfm3 "https://yasumi.neko7ina.com/") && [[ "$api_result" =~ ^[01]$ ]]; then
            echo "$api_result" > status
          else
            echo "::warning:: 接口失效，保留原有status"
          fi
        fi

    - name: 提交status变更
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "📅 $(cat status)"
        file_pattern: status
