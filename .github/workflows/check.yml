name: 精简状态监控系统
on:
  schedule:
    - cron: '0 21 * * *'  # 北京时间05:00触发
  push:
    paths:
      - 'duty'
      - 'leave'

jobs:
  status-tracker:
    runs-on: ubuntu-latest
    steps:
    # ===== 1. 代码检出 =====
    - uses: actions/checkout@v4
      with:
        persist-credentials: false

    # ===== 2. 状态生成 =====
    - name: 生成状态文件
      run: |
        # 精简版状态获取逻辑
        TEMP_FILE=$(mktemp)
        trap 'rm -f "$TEMP_FILE"' EXIT

        # 带失败回退的请求
        if ! curl -fsS --retry 3 "https://yasumi.neko7ina.com/" > "$TEMP_FILE"; then
          echo "::notice:: 使用缓存状态"
          [ -f status ] && cp status "$TEMP_FILE" || echo 1 > "$TEMP_FILE"
        fi

        # 二进制状态验证
        grep -qE '^[01]$' "$TEMP_FILE" || (echo "::error:: 状态值异常"; exit 1)
        mv -f "$TEMP_FILE" status

    # ===== 3. 自动提交 =====
    - uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "系统状态更新"
        file_pattern: 'status'
        commit_options: '--no-verify'
        skip_dirty_check: true  # 强制提交
