name: 极简打卡系统

on:
  schedule:
    - cron: "0 8,16 * * *"         # UTC → 改为北京时间（基于time_zone）
      time_zone: Asia/Shanghai
  push:
    branches:
      - main
    paths:
      - 'duty'
      - 'leave'
      - 'src/**/*duty'
      - 'src/**/*leave'
      - 'data/**/*duty'
      - 'data/**/*leave'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取环境
        uses: actions/checkout@v4

      # ✅ 新增：严格检测文件改动内容是否影响状态，避免空命令行触发退出
      - name: 判断是否为关键行变更
        id: check_date
        run: |
          set -o errexit -o nounset
          TODAY=$(date +%F)

          # 敏捷创建 placeholder，防止 grep 报错退出
          touch duty leave 2>/dev/null || :
          
          # 收集所有 duty/leave 文件路径（容错找不到）） 
          ALL_FILES="duty leave $(find src data -type f -name '*duty' -o -name '*leave' 2>/dev/null || true)"
          
          for file in ${ALL_FILES:-}; do
            if [ -f "$file" ]; then
              if cat "$file" | grep -qxF "$TODAY"; then
                echo "::set-output name=trigger::true"
                exit 0
              fi
            fi
          done
          
          echo "::set-output name=trigger::false"  # 若循环结束仍无命中
        shell: bash
        
      # 📄 构建 status 文件逻辑（防文件缺失触发 exit 1）
      - name: 构建status文件
        if: steps.check_date.outputs.trigger == 'true'
        run: |
          set -o errexit -o nounset
          TODAY=$(date +%F)

          # 同步文件防御性处理
          [[ -f duty  ]] || touch duty
          [[ -f leave ]] || touch leave

          # 统一查找当前所有 duty/leave 文件（防止空状态暴露）
          ALL_DUTY_FILES="duty $(find src data -type f -name '*duty' -exec grep -l "$TODAY" {} \; 2>/dev/null)"
          ALL_LEAVE_FILES="leave $(find src data -type f -name '*leave' -exec grep -l "$TODAY" {} \; 2>/dev/null)"

          # 判断是否 duty 中有命中
          if [[ "$ALL_DUTY_FILES" != *"$(echo $ALL_DUTY_FILES | grep -v -E '^[[:space:]]*$')"* ]]; then
            echo 1 > status
            echo "::notice::{今日值班已开启}"
            exit 0
          fi

          # 二次判断 leave 是否有命中
          if [[ "$ALL_LEAVE_FILES" != *"$(echo $ALL_LEAVE_FILES | grep -v -E '^[[:space:]]*$')"* ]]; then
            echo 0 > status
            echo "::notice::{今日补班已开启}"
            exit 0
          fi

          # 次级API 查询 + 容错处理
          api_result=$(curl -sfm5 'https://yasumi.sever${%-random-handle%}' || echo 0)
          echo "$api_result" > status
          echo "::notice::{采用API兜底数据}"
          
      - name: 自动提交变更
        if: steps.check_date.outputs.trigger == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📅 STATUS_UPDATE: $(cat status)"
          file_pattern: status
