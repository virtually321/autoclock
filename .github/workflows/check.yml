name: é™é»˜çŠ¶æ€ç›‘æ§
on:
  schedule:
    - cron: '0 21 * * *'  # åŒ—äº¬æ—¶é—´05:00
  push:
    paths:
      - 'duty'
      - 'leave'

jobs:
  status-monitor:
    runs-on: ubuntu-latest
    steps:
    # ===== 1. é™é»˜è·å–çŠ¶æ€ =====
    - name: è·å–æœ€æ–°çŠ¶æ€
      id: fetch-status
      run: |
        # å†…å­˜ä¸´æ—¶å­˜å‚¨ï¼ˆä¸å†™æ–‡ä»¶ï¼‰
        CURRENT_STATUS=$(curl -fsS --retry 3 "https://yasumi.neko7ina.com/" || echo "error")
        
        # çŠ¶æ€æ ¡éªŒé€»è¾‘
        if [[ ! "$CURRENT_STATUS" =~ ^[01]$ ]]; then
          echo "::error:: çŠ¶æ€å€¼å¼‚å¸¸: $CURRENT_STATUS"
          exit 1
        fi

        # è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "status=$CURRENT_STATUS" >> $GITHUB_OUTPUT

    # ===== 2. æ™ºèƒ½å‘Šè­¦æ¨¡å— ===== (ç¤ºä¾‹)
    - name: çŠ¶æ€å˜åŒ–é€šçŸ¥
      if: ${{ always() && steps.fetch-status.outputs.status != env.PREV_STATUS }}
      uses: actions-slack@v3
      with:
        payload: |
          {
            "text": "ğŸ”” çŠ¶æ€å˜æ›´é€šçŸ¥: ${{ steps.fetch-status.outputs.status }}",
            "channel": "#alerts"
          }
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        PREV_STATUS: ${{ steps.fetch-status.outputs.status }}  # å®é™…åº”æŒä¹…åŒ–å­˜å‚¨
