name: 静默状态监控
on:
  schedule:
    - cron: '0 21 * * *'  # 北京时间05:00
  push:
    paths:
      - 'duty'
      - 'leave'

jobs:
  status-monitor:
    runs-on: ubuntu-latest
    steps:
    # ===== 1. 静默获取状态 =====
    - name: 获取最新状态
      id: fetch-status
      run: |
        # 内存临时存储（不写文件）
        CURRENT_STATUS=$(curl -fsS --retry 3 "https://yasumi.neko7ina.com/" || echo "error")
        
        # 状态校验逻辑
        if [[ ! "$CURRENT_STATUS" =~ ^[01]$ ]]; then
          echo "::error:: 状态值异常: $CURRENT_STATUS"
          exit 1
        fi

        # 输出供后续步骤使用
        echo "status=$CURRENT_STATUS" >> $GITHUB_OUTPUT

    # ===== 2. 智能告警模块 ===== (示例)
    - name: 状态变化通知
      if: ${{ always() && steps.fetch-status.outputs.status != env.PREV_STATUS }}
      uses: actions-slack@v3
      with:
        payload: |
          {
            "text": "🔔 状态变更通知: ${{ steps.fetch-status.outputs.status }}",
            "channel": "#alerts"
          }
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        PREV_STATUS: ${{ steps.fetch-status.outputs.status }}  # 实际应持久化存储
