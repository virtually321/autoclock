name: ç²¾å‡†çŠ¶æ€ç›‘æ§
on:
  schedule:
    - cron: '0 21 * * *'  # åŒ—äº¬æ—¶é—´05:00è§¦å‘
  push:
    paths:
      - 'duty'
      - 'leave'

jobs:
  status-tracker:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
    # ===== 1. ä»£ç æ£€å‡º =====
    - uses: actions/checkout@v4
      with:
        persist-credentials: false

    # ===== 2. æ—¶é—´ç”Ÿæˆ =====
    - name: ç”Ÿæˆæ—¶é—´æˆ³
      id: timestamp
      run: |
        # ç”Ÿæˆç´§å‡‘æ—¶é—´æ ¼å¼(æœˆ-æ—¥ æ—¶:åˆ†)
        SHORT_TIME=$(TZ='Asia/Shanghai' date +'%m-%d %H:%M')
        echo "ç”Ÿæˆæ—¶é—´ï¼š$SHORT_TIME" | tee time.log
        echo "SHORT_TIME=$SHORT_TIME" >> $GITHUB_ENV

    # ===== 3. çŠ¶æ€ç”Ÿæˆ =====
    - name: ç”ŸæˆçŠ¶æ€æ–‡ä»¶
      run: |
        TEMP_FILE=$(mktemp)
        trap 'rm -f "$TEMP_FILE"' EXIT

        # å¸¦æ™ºèƒ½é‡è¯•çš„ç½‘ç»œè¯·æ±‚
        curl -fsS \
          --retry 3 \
          --retry-delay 2 \
          --retry-max-time 20 \
          --connect-timeout 5 \
          --max-time 10 \
          --retry-all-errors \
          "https://yasumi.neko7ina.com/" > "$TEMP_FILE" || {
          echo "::warning:: APIè¯·æ±‚å¤±è´¥ï¼Œä¿ç•™å½“å‰çŠ¶æ€"
          cp status "$TEMP_FILE" 2>/dev/null || echo 1 > "$TEMP_FILE"
        }

        # çŠ¶æ€æ ¼å¼éªŒè¯
        if ! grep -qE '^[01]$' "$TEMP_FILE"; then
          echo "::error:: æ— æ•ˆçŠ¶æ€å€¼: $(cat "$TEMP_FILE")"
          exit 1
        fi

        mv -f "$TEMP_FILE" status

    # ===== 4. è‡ªåŠ¨æäº¤ =====
    - uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "âœ… çŠ¶æ€æ›´æ–° ï½œ ğŸ•’ ${{ env.SHORT_TIME }}"  # æ–¹æ¡ˆAæ ·å¼
        file_pattern: |
          status
          time.log
        force: true
        branch: ${{ github.ref }}
