name: æç®€æ‰“å¡ç³»ç»Ÿ
on:
  schedule:
    - cron: '0 8,16 * * *'
      time_zone: Asia/Shanghai
  push:
    branches:
      - main
    paths:
      - 'duty'
      - 'leave'
      - 'src/**/*.duty'
      - 'docs/leave'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: ä»…å½“æ—¥æ—¥æœŸè¡Œæ”¹åŠ¨æ—¶æ‰æ‰§è¡Œ
      id: check_date
      run: |
        set -o errexit -o nounset
        TODAY=$(date +%F)
        CHANGED_FILES="duty leave $(find src -name *.duty -o -name *.leave 2>/dev/null)"
        for file in $CHANGED_FILES; do
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„â€œæ”¹äº†â€
          if [ -f "$file" ]; then
            git diff --word-diff=porcelain HEAD^ HEAD "$file" | grep -E -q "([+âˆ’]-)?$TODAY"
            if [ $? -eq 0 ]; then
              echo '::set-output name=trigger::true'
              exit 0
            fi
          fi
        done
        echo '::set-output name=trigger::false'

    - name: æ„å»ºstatuså¹¶æ›´æ–°
      if: steps.check_date.outputs.trigger == 'true'
      run: |
        TODAY=$(date +%F)
        touch duty leave

        if grep -qxF "$TODAY" duty; then
          echo 1 > status
          echo "::notice:: dutyä¸­è®°å½•ä¸ºä¼‘æ¯æ—¥"
        elif grep -qxF "$TODAY" leave; then
          echo 0 > status
          echo "::notice:: leaveä¸­è®°å½•ä¸ºå·¥ä½œæ—¥"
        else
          if api_result=$(curl -sfm3 "https://yasumi.neko7ina.com/") && [[ "$api_result" =~ ^[01]$ ]]; then
            echo "$api_result" > status
          else
            echo "::warning:: æ¥å£å¤±æ•ˆï¼Œä¿ç•™åŸæœ‰status"
          fi
        fi

    - name: æäº¤statuså˜æ›´
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ“… $(cat status)"
        file_pattern: status
