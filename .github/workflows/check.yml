name: æç®€æ‰“å¡ç³»ç»Ÿ

on:
  schedule:
    - cron: "0 8,16 * * *"         # UTC â†’ æ”¹ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆåŸºäºtime_zoneï¼‰
      time_zone: Asia/Shanghai
  push:
    branches:
      - main
    paths:
      - 'duty'
      - 'leave'
      - 'src/**/*duty'
      - 'src/**/*leave'
      - 'data/**/*duty'
      - 'data/**/*leave'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ç¯å¢ƒ
        uses: actions/checkout@v4

      # âœ… æ–°å¢ï¼šä¸¥æ ¼æ£€æµ‹æ–‡ä»¶æ”¹åŠ¨å†…å®¹æ˜¯å¦å½±å“çŠ¶æ€ï¼Œé¿å…ç©ºå‘½ä»¤è¡Œè§¦å‘é€€å‡º
      - name: åˆ¤æ–­æ˜¯å¦ä¸ºå…³é”®è¡Œå˜æ›´
        id: check_date
        run: |
          set -o errexit -o nounset
          TODAY=$(date +%F)

          # æ•æ·åˆ›å»º placeholderï¼Œé˜²æ­¢ grep æŠ¥é”™é€€å‡º
          touch duty leave 2>/dev/null || :
          
          # æ”¶é›†æ‰€æœ‰ duty/leave æ–‡ä»¶è·¯å¾„ï¼ˆå®¹é”™æ‰¾ä¸åˆ°ï¼‰ï¼‰ 
          ALL_FILES="duty leave $(find src data -type f -name '*duty' -o -name '*leave' 2>/dev/null || true)"
          
          for file in ${ALL_FILES:-}; do
            if [ -f "$file" ]; then
              if cat "$file" | grep -qxF "$TODAY"; then
                echo "::set-output name=trigger::true"
                exit 0
              fi
            fi
          done
          
          echo "::set-output name=trigger::false"  # è‹¥å¾ªç¯ç»“æŸä»æ— å‘½ä¸­
        shell: bash
        
      # ğŸ“„ æ„å»º status æ–‡ä»¶é€»è¾‘ï¼ˆé˜²æ–‡ä»¶ç¼ºå¤±è§¦å‘ exit 1ï¼‰
      - name: æ„å»ºstatusæ–‡ä»¶
        if: steps.check_date.outputs.trigger == 'true'
        run: |
          set -o errexit -o nounset
          TODAY=$(date +%F)

          # åŒæ­¥æ–‡ä»¶é˜²å¾¡æ€§å¤„ç†
          [[ -f duty  ]] || touch duty
          [[ -f leave ]] || touch leave

          # ç»Ÿä¸€æŸ¥æ‰¾å½“å‰æ‰€æœ‰ duty/leave æ–‡ä»¶ï¼ˆé˜²æ­¢ç©ºçŠ¶æ€æš´éœ²ï¼‰
          ALL_DUTY_FILES="duty $(find src data -type f -name '*duty' -exec grep -l "$TODAY" {} \; 2>/dev/null)"
          ALL_LEAVE_FILES="leave $(find src data -type f -name '*leave' -exec grep -l "$TODAY" {} \; 2>/dev/null)"

          # åˆ¤æ–­æ˜¯å¦ duty ä¸­æœ‰å‘½ä¸­
          if [[ "$ALL_DUTY_FILES" != *"$(echo $ALL_DUTY_FILES | grep -v -E '^[[:space:]]*$')"* ]]; then
            echo 1 > status
            echo "::notice::{ä»Šæ—¥å€¼ç­å·²å¼€å¯}"
            exit 0
          fi

          # äºŒæ¬¡åˆ¤æ–­ leave æ˜¯å¦æœ‰å‘½ä¸­
          if [[ "$ALL_LEAVE_FILES" != *"$(echo $ALL_LEAVE_FILES | grep -v -E '^[[:space:]]*$')"* ]]; then
            echo 0 > status
            echo "::notice::{ä»Šæ—¥è¡¥ç­å·²å¼€å¯}"
            exit 0
          fi

          # æ¬¡çº§API æŸ¥è¯¢ + å®¹é”™å¤„ç†
          api_result=$(curl -sfm5 'https://yasumi.sever${%-random-handle%}' || echo 0)
          echo "$api_result" > status
          echo "::notice::{é‡‡ç”¨APIå…œåº•æ•°æ®}"
          
      - name: è‡ªåŠ¨æäº¤å˜æ›´
        if: steps.check_date.outputs.trigger == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“… STATUS_UPDATE: $(cat status)"
          file_pattern: status
